

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Defining SQL Queries &#8212; aiosql 3.0.0 documentation</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extending aiosql to additional database drivers" href="driver_adapters.html" />
    <link rel="prev" title="Sync vs Async" href="sync_vs_async.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="driver_adapters.html" title="Extending aiosql to additional database drivers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sync_vs_async.html" title="Sync vs Async"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">aiosql 3.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Defining SQL Queries</a><ul>
<li><a class="reference internal" href="#query-names-comments">Query Names &amp; Comments</a></li>
<li><a class="reference internal" href="#query-operations">Query Operations</a><ul>
<li><a class="reference internal" href="#select-one-row-with">Select One Row with <code class="docutils literal notranslate"><span class="pre">^</span></code></a></li>
<li><a class="reference internal" href="#insert-update-delete-with">Insert/Update/Delete with <code class="docutils literal notranslate"><span class="pre">!</span></code></a></li>
<li><a class="reference internal" href="#insert-returning-with">Insert Returning with <code class="docutils literal notranslate"><span class="pre">&lt;!</span></code></a></li>
<li><a class="reference internal" href="#insert-update-delete-many-with">Insert/Update/Delete Many with <code class="docutils literal notranslate"><span class="pre">*!</span></code></a></li>
<li><a class="reference internal" href="#execute-sql-script-statements-with">Execute SQL script statements with <code class="docutils literal notranslate"><span class="pre">#</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="sync_vs_async.html"
                        title="previous chapter">Sync vs Async</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="driver_adapters.html"
                        title="next chapter">Extending aiosql to additional database drivers</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/defining_queries.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="defining-sql-queries">
<h1>Defining SQL Queries<a class="headerlink" href="#defining-sql-queries" title="Permalink to this headline">¶</a></h1>
<div class="section" id="query-names-comments">
<h2>Query Names &amp; Comments<a class="headerlink" href="#query-names-comments" title="Permalink to this headline">¶</a></h2>
<p>Name definitions are how <code class="docutils literal notranslate"><span class="pre">aiosql</span></code> determines how to name the SQL code blocks which are loaded.
A query name definition is a normal SQL comment starting with “– name:” and is followed by the
name of the query. You can use <code class="docutils literal notranslate"><span class="pre">-</span></code> or <code class="docutils literal notranslate"><span class="pre">_</span></code> in your query names, but the methods in python
will always be valid python names using underscores.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: get-all-blogs</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">blogs</span><span class="p">;</span>
</pre></div>
</div>
<p>The above example when loaded by <code class="docutils literal notranslate"><span class="pre">aiosql.from_path</span></code> will return an object with a
<code class="docutils literal notranslate"><span class="pre">.get_all_blogs(conn)</span></code> method.</p>
<p>Your SQL comments will be added to your methods as python documentation, and accessible by calling
<code class="docutils literal notranslate"><span class="pre">help()</span></code> on them.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: get-all-blogs</span>
<span class="c1">-- Fetch all fields for every blog in the database.</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">blogs</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">aiosql</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s2">&quot;blogs.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite3&quot;</span><span class="p">)</span>
<span class="n">help</span><span class="p">(</span><span class="n">aiosql</span><span class="o">.</span><span class="n">get_all_blogs</span><span class="p">)</span>
</pre></div>
</div>
<p>output</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Help on function get_user_blogs in module aiosql.aiosql:

get_all_blogs(conn, *args, **kwargs)
    Fetch all fields for every blog in the database.
</pre></div>
</div>
</div>
<div class="section" id="query-operations">
<h2>Query Operations<a class="headerlink" href="#query-operations" title="Permalink to this headline">¶</a></h2>
<p>Adding query operator symbols to the end of query names will inform <code class="docutils literal notranslate"><span class="pre">aiosql</span></code> of how to
execute and return results. In the above section the <code class="docutils literal notranslate"><span class="pre">get-all-blogs</span></code> name has no special operator
characters trailing it. This lack of operator is actually the most basic operator which performs
SQL <code class="docutils literal notranslate"><span class="pre">select</span></code> statements and returns a list of rows. When writing an application you will often
need to perform other operations besides selects, like inserts, deletes, and bulk opearations. The
operators detailed in this section let you declare in your SQL, how your code should be executed
by the database driver.</p>
<div class="section" id="select-one-row-with">
<h3>Select One Row with <code class="docutils literal notranslate"><span class="pre">^</span></code><a class="headerlink" href="#select-one-row-with" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">^</span></code> operator will execute the query, and only return the first row of a result set. If there are now rows in the
result set it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>. When using a raw driver this is usually done with <code class="docutils literal notranslate"><span class="pre">cur.fetchone()</span></code> vs
<code class="docutils literal notranslate"><span class="pre">cur.fetchall()</span></code>. This is useful when you know there should be one, and exactly one record for your query. For
instance, if you have a unique index on the username field in your users table so that no two users should ever share
the same username, you could use <code class="docutils literal notranslate"><span class="pre">^</span></code> to tell the driver to only select a single row, and to return it rather than a
list of rows with length of 1.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: get-user-by-username^</span>
<span class="k">select</span> <span class="n">userid</span><span class="p">,</span>
       <span class="n">username</span>
  <span class="k">from</span> <span class="n">users</span>
 <span class="k">where</span> <span class="n">username</span> <span class="o">=</span> <span class="p">:</span><span class="n">username</span><span class="p">;</span>
</pre></div>
</div>
<p>The method generated is:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">get_user_by_username(conn,</span> <span class="pre">username:</span> <span class="pre">str)</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="insert-update-delete-with">
<h3>Insert/Update/Delete with <code class="docutils literal notranslate"><span class="pre">!</span></code><a class="headerlink" href="#insert-update-delete-with" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">!</span></code> operator will execute SQL without returning any results. It is meant for use with <code class="docutils literal notranslate"><span class="pre">insert</span></code>,
<code class="docutils literal notranslate"><span class="pre">update</span></code>, and <code class="docutils literal notranslate"><span class="pre">delete</span></code> statements for which returned data is not required.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: publish-blog!</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">blogs</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="k">values</span> <span class="p">(:</span><span class="n">userid</span><span class="p">,</span> <span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">content</span><span class="p">);</span>

<span class="c1">-- name: remove-blog!</span>
<span class="c1">-- Remove a blog from the database</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">blogs</span> <span class="k">where</span> <span class="n">blogid</span> <span class="o">=</span> <span class="p">:</span><span class="n">blogid</span><span class="p">;</span>
</pre></div>
</div>
<p>The methods generated are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">publish_blog(conn,</span> <span class="pre">*args,</span> <span class="pre">**kwargs)</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">remove_blog(conn,</span> <span class="pre">*args,</span> <span class="pre">**kwargs)</span></code></li>
</ul>
</div></blockquote>
<p>Each of them can be run to alter the database, but both will return <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</div>
<div class="section" id="insert-returning-with">
<h3>Insert Returning with <code class="docutils literal notranslate"><span class="pre">&lt;!</span></code><a class="headerlink" href="#insert-returning-with" title="Permalink to this headline">¶</a></h3>
<p>Sometimes when performing an insert it is necessary to receive some information back about the
newly created database row. The <code class="docutils literal notranslate"><span class="pre">&lt;!</span></code> operator tells aiosql to perform execute the insert query, but to also expect and
return some data.</p>
<p>In SQLite this means the <code class="docutils literal notranslate"><span class="pre">cur.lastrowid</span></code> will be returned.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: publish-blog&lt;!</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">blogs</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="k">values</span> <span class="p">(:</span><span class="n">userid</span><span class="p">,</span> <span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="p">:</span><span class="n">content</span><span class="p">);</span>
</pre></div>
</div>
<p>Will return the <code class="docutils literal notranslate"><span class="pre">blogid</span></code> of the inserted row.</p>
<p>PostgreSQL however allows returning multiple values via the <code class="docutils literal notranslate"><span class="pre">returning</span></code> clause of insert
queries.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: publish-blog&lt;!</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">blogs</span> <span class="p">(</span>
    <span class="n">userid</span><span class="p">,</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">content</span>
<span class="p">)</span>
<span class="k">values</span> <span class="p">(</span>
    <span class="p">:</span><span class="n">userid</span><span class="p">,</span>
    <span class="p">:</span><span class="n">title</span><span class="p">,</span>
    <span class="p">:</span><span class="n">content</span>
<span class="p">)</span>
<span class="n">returning</span> <span class="n">blogid</span><span class="p">,</span> <span class="n">title</span><span class="p">;</span>
</pre></div>
</div>
<p>This will insert the new blog row and return both it’s <code class="docutils literal notranslate"><span class="pre">blogid</span></code> and <code class="docutils literal notranslate"><span class="pre">title</span></code> value as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">aiosql</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s2">&quot;blogs.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;psycopg2&quot;</span><span class="p">)</span>
<span class="n">blogid</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">queries</span><span class="o">.</span><span class="n">publish_blog</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">userid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Hi&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;word.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="insert-update-delete-many-with">
<h3>Insert/Update/Delete Many with <code class="docutils literal notranslate"><span class="pre">*!</span></code><a class="headerlink" href="#insert-update-delete-many-with" title="Permalink to this headline">¶</a></h3>
<p>The DB-API 2.0 drivers like <code class="docutils literal notranslate"><span class="pre">sqlite3</span></code> and <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> have an <code class="docutils literal notranslate"><span class="pre">executemany</span></code> method which
execute a SQL command against all parameter sequences or mappings found in a sequence. This
is useful for bulk updates to the database. The below example is a PostgreSQL statement to insert
many blog rows.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: bulk-publish*!</span>
<span class="c1">-- Insert many blogs at once</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">blogs</span> <span class="p">(</span>
    <span class="n">userid</span><span class="p">,</span>
    <span class="n">title</span><span class="p">,</span>
    <span class="n">content</span><span class="p">,</span>
    <span class="n">published</span>
<span class="p">)</span>
<span class="k">values</span> <span class="p">(</span>
    <span class="p">:</span><span class="n">userid</span><span class="p">,</span>
    <span class="p">:</span><span class="n">title</span><span class="p">,</span>
    <span class="p">:</span><span class="n">content</span><span class="p">,</span>
    <span class="p">:</span><span class="n">published</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Applying this to a list of blogs in python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">aiosql</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s2">&quot;blogs.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;psycopg2&quot;</span><span class="p">)</span>
<span class="n">blogs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;userid&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;First Blog&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">published</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span>
    <span class="p">{</span><span class="s2">&quot;userid&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Next Blog&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">published</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)},</span>
    <span class="p">{</span><span class="s2">&quot;userid&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Hey, Hey!&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="n">published</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">28</span><span class="p">)},</span>
<span class="p">]</span>
<span class="n">queries</span><span class="o">.</span><span class="n">bulk_publish</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">blogs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="execute-sql-script-statements-with">
<h3>Execute SQL script statements with <code class="docutils literal notranslate"><span class="pre">#</span></code><a class="headerlink" href="#execute-sql-script-statements-with" title="Permalink to this headline">¶</a></h3>
<p>Executes some sql statements as a script. These methods don’t do variable substitution, or return
any rows. An example usecase is using data definition statements like create table in order to
setup your database.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- name: create-schema#</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">users</span> <span class="p">(</span>
    <span class="n">userid</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">username</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">firstname</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">lastname</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">blogs</span> <span class="p">(</span>
    <span class="n">blogid</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">userid</span> <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">title</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">content</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">published</span> <span class="nb">date</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="k">CURRENT_DATE</span><span class="p">,</span>
    <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="k">references</span> <span class="n">users</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>From code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">queries</span> <span class="o">=</span> <span class="n">aiosql</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="s2">&quot;create_schema.sql&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite3&quot;</span><span class="p">)</span>
<span class="n">queries</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="driver_adapters.html" title="Extending aiosql to additional database drivers"
             >next</a> |</li>
        <li class="right" >
          <a href="sync_vs_async.html" title="Sync vs Async"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">aiosql 3.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, William Vaughn.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>